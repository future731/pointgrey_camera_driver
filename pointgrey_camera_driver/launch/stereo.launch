<launch>
  <!-- Common parameters -->
  <arg name="camera_name" default="pointgrey" />
  <arg name="frame_rate" default="170" />
  <arg name="exposure"      value="0.004" />
  <arg name="auto_exposure"      value="false" />
  <arg name="auto_gain"     value="false" />
  <arg name="gain"          value="18" />
  <arg name="enable_trigger"          value="true" />
  <arg name="trigger_source"          value="GPIO0" />
  <arg name="trigger_polarity"          value="0" />

  <arg name="camera_serial_l" default="16276501" />
  <arg name="camera_calibrated_l" default="true" />

  <arg name="camera_serial_r" default="16276527" />
  <arg name="camera_calibrated_r" default="true" />
  <arg name="nodelet_manager_name" value="camera_nodelet_manager" />
  <arg name="nodelet_manager_name_absolute" value="/$(arg camera_name)/$(arg nodelet_manager_name)" />

  <group ns="$(arg camera_name)" >
    <node name="$(arg nodelet_manager_name)" pkg="nodelet" type="nodelet" args="manager" />

    <!-- Both cameras are not loaded into one nodelet manager to avoid the namespacing issue. -->
    <!-- node name="camera_nodelet" pkg="nodelet" type="nodelet"
          args="load pointgrey_camera_driver/PointGreyStereoCameraSPNodelet camera_nodelet_manager" launch-prefix="valgrind -v" -->
    <node name="pointgrey_nodelet" pkg="nodelet" type="nodelet"
          args="load pointgrey_camera_driver/PointGreyStereoCameraSPNodelet $(arg nodelet_manager_name)">
      <param name="frame_id_l" value="camera_l" />
      <param name="frame_id_r" value="camera_r" />
      <param name="serial_l" value="$(arg camera_serial_l)" />
      <param name="serial_r" value="$(arg camera_serial_r)" />
      <param name="camera_id_l" value="0" />
      <param name="camera_id_r" value="1" />

      <!-- When unspecified, the driver will use the default framerate as given by the
           camera itself. Use this parameter to override that value for cameras capable of
           other framerates. -->
      <param name="frame_rate" value="$(arg frame_rate)" />
      <param name="auto_exposure" value="$(arg auto_exposure)" />
      <param name="exposure" value="$(arg exposure)" />
      <param name="auto_gain" value="$(arg auto_gain)" />
      <param name="gain" value="$(arg gain)" />
      <param name="enable_trigger" value="$(arg enable_trigger)" />
      <param name="trigger_source" value="$(arg trigger_source)" />
      <param name="trigger_polarity" value="$(arg trigger_polarity)" />

      <!-- Use the camera_calibration package to create this file -->
      <param name="camera_info_url_l" if="$(arg camera_calibrated_l)"
             value="file://$(env HOME)/.ros/camera_info/$(arg camera_serial_l).yaml" />
      <param name="camera_info_url_r" if="$(arg camera_calibrated_r)"
             value="file://$(env HOME)/.ros/camera_info/$(arg camera_serial_r).yaml" />
    </node>

    <include file="$(find image_proc)/launch/image_proc.launch" ns="left">
        <arg name="manager" value="$(arg nodelet_manager_name_absolute)" />
    </include>
    <group ns="left">
        <node name="hsv" pkg="nodelet" type="nodelet"
            args="load opencv_apps/hsv_color_filter $(arg nodelet_manager_name_absolute)">
            <remap from="image" to="/$(arg camera_name)/left/image_rect_color" />
            <param name="h_limit_max" value="20" /> <!--doc="The maximum allowed field value Hue"-->
            <param name="h_limit_min" value="0" /> <!--doc="The minimum allowed field value Hue"-->
            <param name="s_limit_max" value="180" /> <!--doc="The maximum allowed field value Hue"-->
            <param name="s_limit_min" value="70" /> <!--doc="The minimum allowed field value Hue"-->
            <param name="v_limit_max" value="256" /> <!--doc="The maximum allowed field value Hue"-->
            <param name="v_limit_min" value="240" /> <!--doc="The minimum allowed field value Hue"-->
            <param name="debug_view" value="false" />
        </node>
        <node name="erode" pkg="nodelet" type="nodelet"
            args="load jsk_perception/ErodeMaskImage $(arg nodelet_manager_name_absolute)">
            <remap from="~input" to="hsv/image" />
            <rosparam>
                method: 0
                size: 5
                iterations: 1
            </rosparam>
        </node>
        <node name="dilate" pkg="nodelet" type="nodelet"
            args="load jsk_perception/DilateMaskImage $(arg nodelet_manager_name_absolute)">
            <remap from="~input" to="erode/output" />
            <rosparam>
                method: 0
                size: 12
                iterations: 2
            </rosparam>
        </node>
        <node name="centroid" pkg="nodelet" type="nodelet"
            args="load opencv_apps/contour_moments $(arg nodelet_manager_name_absolute)">
            <remap from="image" to="dilate/output" />
            <param name="debug_view" value="false" />
            <param name="use_camera_info" value="false" />
        </node>
    </group>
    <include file="$(find image_proc)/launch/image_proc.launch" ns="right">
        <arg name="manager" value="$(arg nodelet_manager_name_absolute)" />
    </include>
    <group ns="right">
        <node name="hsv" pkg="nodelet" type="nodelet"
            args="load opencv_apps/hsv_color_filter $(arg nodelet_manager_name_absolute)">
            <remap from="image" to="/$(arg camera_name)/right/image_rect_color" />
            <param name="h_limit_max" value="20" /> <!--doc="The maximum allowed field value Hue"-->
            <param name="h_limit_min" value="0" /> <!--doc="The minimum allowed field value Hue"-->
            <param name="s_limit_max" value="180" /> <!--doc="The maximum allowed field value Hue"-->
            <param name="s_limit_min" value="70" /> <!--doc="The minimum allowed field value Hue"-->
            <param name="v_limit_max" value="256" /> <!--doc="The maximum allowed field value Hue"-->
            <param name="v_limit_min" value="240" /> <!--doc="The minimum allowed field value Hue"-->
            <param name="debug_view" value="false" />
        </node>
        <node name="erode" pkg="nodelet" type="nodelet"
            args="load jsk_perception/ErodeMaskImage $(arg nodelet_manager_name_absolute)">
            <remap from="~input" to="hsv/image" />
            <rosparam>
                method: 0
                size: 5
                iterations: 1
            </rosparam>
        </node>
        <node name="dilate" pkg="nodelet" type="nodelet"
            args="load jsk_perception/DilateMaskImage $(arg nodelet_manager_name_absolute)">
            <remap from="~input" to="erode/output" />
            <rosparam>
                method: 0
                size: 12
                iterations: 2
            </rosparam>
        </node>
        <node name="centroid" pkg="nodelet" type="nodelet"
            args="load opencv_apps/contour_moments $(arg nodelet_manager_name_absolute)">
            <remap from="image" to="dilate/output" />
            <param name="debug_view" value="false" />
            <param name="use_camera_info" value="false" />
        </node>
    </group>
    <!--node name="rosbag" pkg="nodelet" type="nodelet"
        args="load nodelet_rosbag/NodeletRosbag $(arg nodelet_manager_name_absolute)"/-->
    <!--node name="sync_nodelet" pkg="nodelet" type="nodelet"
          args="load pointgrey_camera_driver/PointGreySyncStereoImagesNodelet $(arg nodelet_manager_name)">
      <param name="approximate_sync" value="true" />
        <param name="queue_size" value="5" />
    </node-->
    <node name="disparity" pkg="nodelet" type="nodelet"
        args="load stereo_image_proc/disparity $(arg nodelet_manager_name_absolute)">
        <remap from="left/image_rect" to="left/dilate/output" />
        <remap from="right/image_rect" to="right/dilate/output" />
        <param name="approximate_sync" value="true" />
    </node>
    <node name="point_cloud2" pkg="nodelet" type="nodelet"
        args="load stereo_image_proc/point_cloud2 $(arg nodelet_manager_name_absolute)">
        <param name="approximate_sync" value="true" />
        <param name="queue_size" value="100" />
    </node>
  </group>
</launch>
